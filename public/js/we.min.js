var WE={extend:$.extend,ui:{},kit:{},api:{},page:{},Observer:{notice:function(){Array.prototype.unshift.call(arguments,{target:this,data:arguments[0]});for(var a=0;this.observers&&a<this.observers.length;a++)try{this.observers[a].update.apply(this.observers[a],arguments)}catch(b){window.console&&console.log(b)}},addObserver:function(a){if(a&&a.update){if(!this.observers)this.observers=[];this.observers.push(a)}else console.error("observer.update not fucntion ")},removeObserver:function(a){for(var b=
0;this.observers&&b<this.observers.length;b++)a===this.observers[b]&&(this.observers.splice(b,1),b--)}}};WE.Controller=function(a){this.msg={"-99":"\u670d\u52a1\u5668\u9519\u8bef"};a&&WE.extend(this,a)};WE.Controller.prototype={constructor:WE.Controller,update:function(a){a.code!=0&&WE.ui.alert(this.getCodeMsg(a.code))},error:function(a){window.console&&console.log("xhr \u9519\u8bef",a.status)},getCodeMsg:function(a){var b=this.msg?this.msg[a]:null;return b?b:"\u9519\u8bef\u4ee3\u7801:"+a}};
WE.BaseModel=function(a){this.init(a)};WE.BaseModel.prototype={constructor:WE.BaseModel,init:function(a){a&&WE.extend(this,a)},error:function(a,b){for(var c=this.observers,d=0;c&&d<c.length;d++)c[d].error&&c[d].error(a,b)},post:function(a,b){var c=this;$.ajax({url:a,type:"post",data:b,dataType:"json",error:function(b,a){c.error(b,a)},success:function(b){c.notice(b)}})},get:function(a,b){var c=this;$.ajax({url:a,type:"get",data:b,dataType:"json",error:function(b,a){c.error(b,a)},success:function(b){c.notice(b)}})}};
WE.extend(WE.BaseModel.prototype,WE.Observer);WE.extend(WE.kit,{cache:{},tmpl:function(a,b){var c=!/\W/.test(a)?cache[a]=cache[a]||tmpl(document.getElementById(a).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+a.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return b?c(b):c},pad:function(a,b,c){if(b-String(a).length<
0)return a;b=Array(b-String(a).length||0);b.push(a);return b.join(c||"0")},format:function(a,b){var a=new Date(a),c=this.pad,d={yy:String(a.getFullYear()).slice(-2),yyyy:a.getFullYear(),M:a.getMonth()+1,MM:c(a.getMonth()+1,2,"0"),d:a.getDate(),dd:c(a.getDate(),2,"0"),h:a.getHours(),hh:c(a.getHours(),2,"0"),m:a.getMinutes(),mm:c(a.getMinutes(),2,"0"),s:a.getSeconds(),ss:c(a.getSeconds(),2,"0")};return(b||"yyyy-MM-dd hh:mm:ss").replace(/yyyy|yy|MM|M|dd|d|hh|h|mm|m|ss|s/g,function(b){return d[b]})},
sortFormat:function(a){return this.format(a,"yyyy-MM-dd")},longFormat:function(a){return this.format(a,"yyyy-MM-dd hh:mm:ss")},getTmpl:function(a,b){var c=this;c.cache[a]?b&&b(c.cache[a]):$.ajax({url:"/sys/tmpl",medthod:"get",data:{path:a},success:function(d){c.cache[a]=d;b&&b(d)}})},weTime:function(){var a=[{t:6E4,s:"\u521a\u521a"},{t:12E4,s:"1\u5206\u949f"},{t:18E4,s:"2\u5206\u949f"},{t:36E4,s:"5\u5206\u949f"},{t:66E4,s:"10\u5206\u949f"},{t:18E5,s:"30\u5206\u949f"},{t:36E5,s:"1\u5c0f\u65f6"},{t:72E5,
s:"2\u5c0f\u65f6"},{t:18E6,s:"5\u5c0f\u65f6"},{t:864E5,s:"1\u5929\u524d"},{t:1728E5,s:"2\u5929\u524d"}];return function(b){for(var c=(new Date).getTime()-b,d=0;d<a.length;)if(a[d++].t>c)return a[d-1].s;return WE.kit.format(b,"MM-dd hh:mm:ss")}}()});WE.extend(WE.kit,function(){function a(b){var a={dragElement:null,moveElement:null,isRange:!0,isResize:!0,patchWidth:0,patchHeight:0,patchTop:0,patchLeft:0};this.left=this.top=this.height=this.width=0;$.extend(a,b);this.option=a;this.events={}}a.prototype={init:function(){var b=this;this.option.iscap=this.option.dragElement[0].setCapture?!0:!1;$.extend(this.events,{down:function(a){b.down(a);return!1},up:function(a){b.up(a);return!1},move:function(a){b.move(a);return!1}});this.zIndex();this.createMask();
this.option.isRange&&!this.option.range&&this.setRangeWindow();this.start();this.setResize();this.onready()},zIndex:function(){this.minzIndex=this.option.dragElement.css("z-index")||10},createMask:function(){this.mask=$('<div style="position:fixed;display:none;top:0;left:0;opacity:0;background:#000;filter:alpha(opacity=0)"></div>');this.setMask(0,0,$(window).width(),$(window).height(),this.minzIndex+1);$("#mxDialogWarp").append(this.mask)},showMask:function(){this.mask.show()},hideMask:function(){this.mask.hide()},
removeMask:function(){this.mask.remove()},setMask:function(b,a,d,e,f){this.mask.css({top:b,left:a,width:d,height:e,"z-index":f})},setMaskIndex:function(b){this.mask.css("z-index",b||WE.ui.Dialog.index)},start:function(){this.option.dragElement.bind("mousedown",this.events.down)},down:function(b){var a=this.option.dragElement,d=this.option.moveElement,e=$(document),f=d.offset();this.width=d.width();this.height=d.height();this.setRangeWindow();this.option.iscap&&a[0].setCapture();this.offset={x:b.screenX-
f.left,y:b.screenY-f.top};this.showMask();e.bind("mousemove",this.events.move);e.bind("mouseup",this.events.up);this.onfocus(b.screenX,b.screenY)},move:function(b){var a=this.option.moveElement,d=this.offset,e=b.screenX-d.x-$(window).scrollLeft(),b=b.screenY-d.y-$(window).scrollTop();if(this.option.isRange)b=this.checkBoundary(e,b),e=b.x,b=b.y;this.left=e;this.top=b;a[0].style.left=e+"px";a[0].style.top=b+"px";this.onmove(e,b)},up:function(){var b=$(document),a=this.option.dragElement;this.option.iscap&&
a[0].releaseCapture();this.hideMask();b.unbind("mousemove",this.events.move);b.unbind("mouseup",this.events.up);this.onblur()},stop:function(){this.removeMask()},checkBoundary:function(b,a){var d=this.option.range;$("#movebox").text(d[3]+"-"+this.height);b=b>d[2]-this.width?d[2]-this.width:b;a=a>d[3]-this.height?d[3]-this.height:a;b=b<d[0]?d[0]:b;a=a<d[1]?d[1]:a;return{x:b,y:a}},setResize:function(){var b=this;if(!this.option.isResize)return this.option.moveElement.find(".mx-dialog-change").hide(),
!1;this.resize=new WE.kit.Resize({dragElements:this.option.moveElement.find(".mx-dialog-change"),sizeElement:this.option.moveElement});this.resize.onfocus=function(){b.showMask();b.setMaskIndex()};this.resize.onblur=function(a,d,e,f){b.width=a;b.height=d;b.top=f;b.left=e;b.onResize();b.hideMask()};this.resize.init()},setRange:function(b,a,d,e){this.option.range=[b,a,d,e]},setRangeWindow:function(){var a=this.option.patchTop,c=this.option.patchLeft,d=$(window).width()-this.option.patchWidth,e=$(window).height()-
this.option.patchHeight;this.option.range=[c,a,d,e];this.setMask(0,0,d,e,this.minzIndex)},onfocus:function(){},onblur:function(){},onmove:function(){},onexit:function(){},onready:function(){},onResize:function(){}};return{DragElement:a}}());WE.kit.textarea={getPos:function(a){if(document.selection){a.focus();var b=document.selection.createRange(),c=b.duplicate();c.moveToElementText(a);c.setEndPoint("EndToEnd",b);a.selectionStart=c.text.length-b.text.length;a.selectionEnd=a.selectionStart+b.text.length}return a.selectionStart},setPos:function(a,b){this.select(a,b,b)},add:function(a,b){if(document.selection)a.focus(),document.selection.createRange().text=b;else{var c=a.selectionStart,d=a.value.length;a.value=a.value.slice(0,a.selectionStart)+
b+a.value.slice(a.selectionStart,d);this.setPos(a,c+b.length)}},del:function(a,b){var c=this.getPos(a),d=a.value;a.value=b>0?d.slice(0,c-b)+d.slice(c):d.slice(0,c)+d.slice(c-b);this.setPos(a,c-(b<0?0:b))},select:function(a,b,c){if(document.selection){var d=a.createTextRange();d.moveEnd("character",-a.value.length);d.moveEnd("character",c);d.moveStart("character",b);d.select()}else a.setSelectionRange(b,c),a.focus()},selectString:function(a,b){var c=a.value.indexOf(b);c!=-1&&this.select(a,c,c+b.length)}};WE.extend(WE.ui,{ok:function(a,b){var c=this.tip({context:a,okbtn:!1,cancelbtn:!1,type:"success",timeout:b||3E3,title:"\u63d0\u793a"});c.ui.close.focus();return c},alert:function(a,b){if(this.alert.tip)this.alert.tip.option.callback=null,this.alert.tip.close();var c=this.tip({context:a,cancelbtn:!1,type:"notice",callback:b,title:"\u63d0\u793a"});c.ui.ok.focus();return this.alert.tip=c},confirm:function(a,b){if(this.confirm.tip)return this.confirm.tip;var c=this,d=this.tip({context:a,closebtn:!1,type:"notice",
callback:function(a){c.confirm.tip=null;b&&b(a=="ok"?!0:!1)},title:"\u63d0\u793a"});this.confirm.tip=d;d.ui.ok.focus();return d},tip:function(){function a(a){this.option={title:"\u63d0\u793a",context:"hello world",callback:function(){},timeout:0,okbtn:!0,cancelbtn:!0,closebtn:!0,type:"notice"};$.extend(this.option,a);this.init()}a.prototype={init:function(){var a=WE.kit.tmpl('<div class="moxian-ui-tip">\t\t\t\t<div class="ui-tip-wrapper">\t\t\t\t\t<div class="ui-tip-main">\t\t\t\t\t\t<div class="ui-tip-title">\t\t\t\t\t\t\t<h1><%=title%></h1>\t\t\t\t\t\t\t<%if(closebtn){%>\t\t\t\t\t\t\t<input type="button" class="ui-btn-close pngbg" title="\u5173\u95ed" />\t\t\t\t\t\t\t<%}%>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="ui-tip-context">\t\t\t\t\t\t\t<%if(type){%>\t\t\t\t\t\t\t<p class="p">\t\t\t\t\t\t\t\t<span class="ui-tip-icon ui-tip-<%=type%>"></span><span><%=context%></span>\t\t\t\t\t\t\t</p>\t\t\t\t\t\t\t<%}else{%>\t\t\t\t\t\t\t\t<%=context%>\t\t\t\t\t\t\t<%}%>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="ui-tip-btn">\t\t\t\t\t\t\t<%if(okbtn){%>\t\t\t\t\t\t\t\t<input type="button" title="\u786e\u5b9a" class="btn-primary js_ok" value="\u786e\u5b9a" />\t\t\t\t\t\t\t<%}%>\t\t\t\t\t\t\t<%if(cancelbtn){%>\t\t\t\t\t\t\t\t<input type="button" title="\u53d6\u6d88" class="btn marl10 js_cancel" value="\u53d6\u6d88" />\t\t\t\t\t\t\t<%}%>\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t\t<div class="ui-tip-bg">\u80cc\u666f</div>\t\t\t</div>',
this.option),a=$("<div></div>").append(a);this.ui={wrapper:a.find(".moxian-ui-tip"),title:a.find(".ui-tip-title"),close:a.find(".ui-btn-close"),ok:a.find(".js_ok"),cancel:a.find(".js_cancel")};$(document.body).append(a.find(".moxian-ui-tip"));this.regEvent();this.option.timeout&&this.setTimeout(this.option.timeout);(new WE.kit.DragElement({dragElement:this.ui.title,moveElement:this.ui.wrapper,isRange:!1,isResize:!1,offsetTop:0})).init();this.updatePos()},regEvent:function(){function a(d){d.keyCode==
27&&(c.close("close"),$(window).unbind("keyup",a))}var c=this;this.ui.close.click(function(){c.close("close")});this.ui.ok.click(function(){c.close("ok")});this.ui.cancel.click(function(){c.close("cancel")});$(document).keyup(a)},close:function(a){this.ui.wrapper.remove();this.option.callback&&this.option.callback(a)},updatePos:function(){var a=$(window).height(),c=$(window).width();this.setPos((a-this.ui.wrapper.height())/2,(c-this.ui.wrapper.width())/2)},setTimeout:function(a){var c=this;setTimeout(function(){c.close("auto")},
a)},setPos:function(a,c){this.ui.wrapper.css({top:a+"px",left:c+"px"})}};return function(b){return new a(b)}}()});WE.api=WE.api||{};WE.api.AtModel=function(){this.searchURL="/main/search.php"};WE.api.AtModel.prototype=new WE.BaseModel;WE.extend(WE.api.AtModel.prototype,{searchFirends:function(a){this.get(this.searchURL,{action:"search_name",search_value:a})}});WE.At=function(a,b){this.textarea=a;this.offsetTop=2;this.status=this.width=this.offsetLeft=0;this.currentIndex=-1;this.key="";WE.extend(this,b||{});this.init()};WE.At.isinit=0;WE.At.status=0;
WE.At.regEvent=function(){$(window).click(function(){WE.At.status=0;WE.At.ui.box.addClass("hidden")})};WE.At.create=function(a){for(var b=0;b<a.length;b++)new WE.At($(a[b]))};
WE.At.prototype={constructor:WE.At,tmpl:'<div class="mx-at-box hidden" id="mxatbox">\t\t<div class="mx-at">\t\t\t<div class="mx-at-title">\u9009\u62e9</div>\t\t\t<div class="mx-at-list"></div>\t\t</div>\t</div>',listTmpl:'<ul>\t\t<%for(var i=0; i<data.length; i++){%>\t\t\t<li data-index="<%=i%>"><a href="javascript:void(0);"><%=data[i].name%></a></li>\t\t<%}%>\t</ul>',init:function(){var a="",b={};if(WE.At.isinit==0)a=WE.kit.tmpl(this.tmpl,{}),$(document.body).append(a),b.box=$("#mxatbox"),b.title=
b.box.find(".mx-at-title"),b.list=b.box.find(".mx-at-list"),WE.At.ui=b,WE.At.regEvent();WE.At.isinit++;this.ui=WE.At.ui;this.regEvent()},regEvent:function(){var a=this;this.textarea.keyup(function(b){WE.At.status==1&&(b.keyCode==40||b.keyCode==38||b.keyCode==13)||a.textEventHandle(b)});this.textarea.click(function(b){a.textEventHandle(b);return!1});this.textarea.blur(function(){setTimeout(function(){a.hide()},1E3)});this.textarea.keydown(function(b){if(WE.At.status==1&&(b.keyCode==40||b.keyCode==
38||b.keyCode==13))return b.keyCode==40&&a.keyCode40(),b.keyCode==38&&a.keyCode38(),b.keyCode==13&&a.keyCode13(),!1})},selfRegEvent:function(){var a=this;this.ui.list.find("li").mouseover(function(){var b=$(this).attr("data-index");a.selectIndex(b)});this.ui.list.find("li").click(function(){a.currentIndex=$(this).attr("data-index");a.keyCode13()})},keyCode38:function(){var a=this.listData.length-1,b=this.currentIndex-1,b=b>a?0:b;this.selectIndex(b<0?a:b)},keyCode40:function(){var a=this.listData.length-
1,b=this.currentIndex+1,b=b>a?0:b;this.selectIndex(b<0?a:b)},keyCode13:function(){if(this.currentIndex!=-1){var a=this.listData[this.currentIndex];this.key.length>0&&WE.kit.textarea.del(this.textarea[0],this.key.length);WE.kit.textarea.add(this.textarea[0],a.name+" ");this.hide()}},selectIndex:function(a){var b=this.ui.list.find("li");b.eq(this.currentIndex).removeClass("on");b.eq(a).addClass("on");this.currentIndex=a},textEventHandle:function(){var a=WE.kit.textarea.getPos(this.textarea[0]),b=this.textarea.val().slice(a-
20<0?0:a-20,a),a=String(b).length,b=String(b).match(/@([^@\s]{0,20})$/);a&&b?this.searchFirends(b[1]||""):this.hide()},showList:function(a){WE.At.lastFoucsTextarea!=this.textarea&&this.updatePosition();this.key==""?this.ui.title.text("\u9009\u62e9\u6700\u8fd1\u8054\u7cfb\u4eba"):this.ui.title.text("\u9009\u62e9\u60f3\u8981AT\u7684\u4eba\uff0c\u7a7a\u683c\u5b8c\u6210\u8f93\u5165");a=a.slice(0,10);this.ui.list.html(WE.kit.tmpl(this.listTmpl,{data:a}));this.listData=a;this.show();this.selectIndex(0);
this.selfRegEvent()},hide:function(){WE.At.status=0;this.ui.box.addClass("hidden")},show:function(){WE.At.status=1;this.ui.box.removeClass("hidden")},updatePosition:function(){WE.At.lastFoucsTextarea=this.textarea;var a=this.textarea.offset(),b=this.textarea.innerWidth(),c=this.textarea.innerHeight(),c=a.top+c+this.offsetTop+"px",a=a.left+this.offsetLeft+"px",b=this.width?this.width:b<150||b>200?200:b+2;this.ui.box.css({left:a,top:c,width:b+"px"})},searchFirends:function(a){this.key=a;var b=this,
c=new WE.api.AtModel,d=new WE.Controller(c);d.update=function(a){b.showList(a.data)};c.addObserver(d);c.searchFirends(a||"")}};WE.Dialog=function(a){var b=null;if((this.id=a.id)&&WE.Dialog.getItem(this.id))return b=WE.Dialog.getItem(this.id),b.isRepeat=!0,b.isRepeat;this.html=a.html;this.width=a.width||0;this.height=a.height||0;this.wrap=$('<div class="we-dialog"><div class="we-dialog-in"></div></div>');this.ui={wrap:this.wrap,content:this.wrap.find(".we-dialog-in")};this.init()};WE.Dialog.list={};WE.Dialog.getItem=function(a){return this.list[a]};WE.Dialog.setItem=function(a,b){this.list[a]=b};
WE.Dialog.remove=function(a){this.list[a]=null};
WE.Dialog.prototype={constructor:WE.Dialog,init:function(){var a=this;this.id&&WE.Dialog.setItem(this.id,this);this.ui.content.html(this.html);document.body.appendChild(this.ui.wrap[0]);this.width!=0?this.ui.wrap.width(this.width):this.width=this.ui.wrap.width();this.height!=0?this.ui.wrap.height(this.height):this.height=this.ui.wrap.height();this.ui.wrap.css({top:-this.height+"px",left:"50%",marginLeft:-(this.width/2)+"px"});this.ui.wrap.find(".out").click(function(){a.close(1)})},show:function(){this.ui.wrap.animate({top:0})},
close:function(){var a=this;this.ui.wrap.animate({top:-this.height+"px"},function(){a.ui.wrap.remove();WE.Dialog.remove(a.id)})},onclose:function(){return!0}};
